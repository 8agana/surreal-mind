# SurrealMind MCP — Critical Code Review
Date: 2025-09-17
Reviewer: Codex (GPT-5)
Scope: `src/server`, `src/tools` (thinking, unified_search, inner_voice, maintenance), supporting modules

## Blockers
- **Duplicate DB bootstrap drops retry guarantees** — `src/server/mod.rs:427-507`
  - After the guarded `Surreal::new` loop successfully connects and authenticates, the code immediately redefines `db` and opens a second connection without the backoff/retry guard. A transient failure on the second call now aborts startup even though the first connection succeeded, and we lose the authenticated handle that already selected the namespace/DB. This also doubles the connection load on launch.
  - *Fix*: Remove the second connection block and reuse the already authenticated handle; if a fresh handle is required, wrap it in the same retry logic instead of dropping the working one.

## High Severity
- **Continuity links accept non-existent thought IDs** — `src/tools/thinking.rs:585-619`
  - In `resolve_continuity_links`, the `type::thing` path treats any successful query execution (`Ok(vec![])`) as presence; it never checks that the row set is non-empty. Invalid `thoughts:<id>` references therefore slip through as “record”, corrupting continuity metadata and making downstream traversal fail silently.
  - *Fix*: Require `!rows.is_empty()` before returning the record variant; otherwise downgrade to the string branch or emit a validation error.

- **Unified search truncates unsorted results** — `src/tools/unified_search.rs:188-207`
  - Entity matches are filtered by similarity but never ordered; the DB query orders by `created_at`, and we truncate to `top_k_mem` before sorting. As a result, high-similarity items can be dropped while unrelated but recent rows are returned, breaking semantic search quality.
  - *Fix*: Either sort `scored_entities` by similarity desc before truncation or push the ordering into the SQL (`ORDER BY similarity DESC`).

## Medium Severity
- **Planner / Grok fallbacks ignore HTTP status codes** — `src/tools/inner_voice.rs:1430-1487`
  - Both `call_planner_grok` and `call_grok` go straight to `resp.json()` without checking `resp.status()`. 4xx/5xx responses surface later as “No valid response” which hides the real failure and prevents targeted retry/backoff.
  - *Fix*: Inspect `status`; map non-success to a descriptive `SurrealMindError` before attempting to parse.

- **`maintenance_ops.export_removals` advertises Parquet but writes JSON** — `src/tools/maintenance.rs:440-500`
  - The handler rejects any format except `parquet`, produces a `.parquet` filename, yet actually writes JSON. Downstream tooling expecting Parquet will fail to read the file.
  - *Fix*: Either implement real Parquet export or change the accepted format/extension to match JSON until Parquet support lands.

## Additional Observations / Follow-ups
- No regression tests cover continuity validation or the unified search behavior; consider adding targeted tests once the fixes land.
- The CLI candidate extractor silently swallows spawn failures (`if let Ok((ec, rc)) = ...`), which makes debugging harder—consider emitting telemetry when the CLI path errors out.
