# Surreal Mind — Critical Code Review (2025-09-05)

## Summary
- Top 3 proposed fixes (actionable now):
  1) Enforce whitelist on tag merge from framework analysis in think_convo to avoid unapproved tags persisting. (Implemented minimal diff suggestion provided below.)
  2) Tighten enhancement timeout handling and telemetry in think_convo; ensure finalize metric is always emitted and strict mode drop doesn’t corrupt flow. (Confirmed pattern; included test suggestion.)
  3) Ensure dynamic SQL binding order in inner_voice thought candidate fetch matches finalized SQL string to avoid binding stale placeholders. (Implemented minimal reordering as suggested below.)
- Overall health: Codebase is consistent, deterministic where required, and favors env-tunable controls. Most runtime risks relate to DB availability and envelope validation edge cases.
- Additional robustness (from GPT‑5 quick review): make re-embed HTTP SQL parsing resilient (scan for first block with a result array; normalize ids via `meta::id(id)`), and add descriptive User-Agent strings to SurrealDB/OpenAI HTTP clients.
- Performance: Embedding + retrieval paths are efficient; candidate pools and thresholds are tunable at runtime. Avoid UNION pitfalls with multi-statement queries.
- Maintainability: Clear separation of tools, frameworks, and server routing. Some tests could be added for framework strictness and tag merge behavior.
- Ergonomics: Always-visible tools reduce client friction; feature gating happens in handlers. Logging respects preview redaction and MCP_NO_LOG.

## Findings by Severity

### High
1) Tag merge in think_convo allowed non-whitelisted tags to persist.
   - Risk: Drift of uncontrolled tags increases entropy and affects downstream retrieval filters.
   - Location: src/tools/convo_think.rs (tag merge after framework_analysis)
   - Fix: Filter merged set by SURR_THINK_TAG_WHITELIST before updating thought.tags.

2) Dynamic SQL binding order in inner_voice thought candidate fetch could bind date params before the SQL included those placeholders.
   - Risk: SurrealDB query mismatches in some driver versions or future edits; brittle maintenance.
   - Location: src/tools/inner_voice.rs (fetch_thought_candidates)
   - Fix: Build complete SQL first, then instantiate query and apply binds in the same order. This was adjusted.

### Medium
0) Re-embed robustness in HTTP SQL parsing and ID handling (SurrealDB HTTP).
   - Risk: Assuming a fixed response block index leads to flakiness across SurrealDB versions; mixed Thing/string ids cause brittle parsing.
   - Location: src/lib.rs (run_reembed).
   - Fix: Select `meta::id(id)` in SQL and, when parsing, locate the first block that contains a `result` array instead of indexing at [1]. Add a small helper for legacy Thing objects if needed.
1) Enhancement timeout surface in think_convo could be made more explicit in tests.
   - Risk: Regressions where framework tasks hang longer than expected without failing the request gracefully.
   - Suggestion: Add a unit test that forces strict_json with deliberately invalid envelope sizes to ensure drop path is exercised.

2) Determinism guardrails for framework seed are good; add test that validates tag whitelist enforcement end-to-end.
   - Risk: Unexpected tag additions if whitelist env changes.

3) Unified search: sim_thresh default applies only to thoughts; document in schema.rs comment for clarity.

### Low
0) Observability: Missing explicit `User-Agent` strings on reqwest clients.
   - Value: Easier tracing in Surreal logs and network monitors without changing behavior.
   - Location: src/lib.rs (HTTP SQL client), src/embeddings.rs (OpenAI client)
   - Fix: Set UA to `surreal-mind/<version> <component>; ns=<ns> db=<db>` and `surreal-mind/<version> embeddings` respectively.
1) Minor log key naming consistency: use think.convo.* consistently (already largely consistent).
2) Nit: Normalize env strings with trim() when splitting whitelist and lexicons; currently fine but harmless to keep tidy.

## Enhancements / Improvements (Minimal Diffs)

1) think_convo: Enforce tag whitelist on merge
- Rationale: Prevent non-approved tags from persisting and keep thought.tags aligned with env policy.
- File: src/tools/convo_think.rs, inside enhancement writeback
- Minimal diff:

    // Merge tags, then filter by whitelist to ensure only allowed tags persist
    let existing_tags: Vec<String> = params.tags.unwrap_or_default();
    let envelope_tags: Vec<String> = tags
        .iter()
        .filter_map(|t| t.as_str())
        .map(|s| s.to_string())
        .collect();
    let mut merged_set: HashSet<String> = existing_tags.into_iter().collect();
    merged_set.extend(envelope_tags.into_iter());
    // Build whitelist from env (same source used by framework)
    let whitelist: HashSet<String> = std::env::var("SURR_THINK_TAG_WHITELIST")
        .unwrap_or("plan,debug,dx,photography,idea".to_string())
        .split(',')
        .map(|s| s.trim().to_string())
        .collect();
    let merged: Vec<String> = merged_set
        .into_iter()
        .filter(|t| whitelist.contains(t))
        .collect();
    query.push_str(", tags = $merged_tags");
    binds.push((
        "merged_tags",
        serde_json::Value::Array(merged.into_iter().map(serde_json::Value::String).collect()),
    ));

2) inner_voice: Ensure SQL is finalized before constructing/binding query
- Rationale: Avoid placeholder drift; clearer flow.
- File: src/tools/inner_voice.rs, fetch_thought_candidates
- Minimal diff (concept):

    // finalize SQL first
    sql.push_str(" LIMIT $limit");
    // then build query and bind
    let mut query = self.db.query(&sql).bind(("dim", q_dim));
    // bind optional date params after final SQL
    if let Some(date_range) = date_filter { /* ... */ }
    // bind include/exclude tag params last
    for (i, tag) in include_tags.iter().enumerate() {
        query = query.bind((format!("tag{}", i), tag.clone()));
    }
    for (i, tag) in exclude_tags.iter().enumerate() {
        query = query.bind((format!("etag{}", i), tag.clone()));
    }
    let mut response = query.bind(("limit", cap as i64)).await?;

3) Framework tests: strict_json overflow
- Rationale: Assert drop path when limits exceeded; protects strict serialization constraints.
- File: src/frameworks/convo.rs (tests)
- Suggested test:

    #[test]
    fn test_strict_limits_drop() {
        let opts = ConvoOpts { strict_json: true, tag_whitelist: vec!["plan".into()], timeout_ms: 200 };
        let data = ConvoData {
            summary: "x".repeat(141),
            takeaways: vec!["a".into()],
            prompts: vec!["b".into(), "c".into(), "d".into()],
            next_step: "step".into(),
            tags: vec![],
        };
        // validate() should error in strict mode
    assert!(super::validate(&data, opts.strict_json).is_err());
    }

4) run_reembed (HTTP SQL): resilient parsing + stable ids
- Rationale: Handle SurrealDB multi-block responses and normalize ids at the source.
- File: src/lib.rs (run_reembed)
- Minimal diff (concept):

    // SQL: normalize id to string
    let select_sql = format!(
      "USE NS {} DB {}; SELECT meta::id(id) AS id, content, created_at, array::len(embedding) AS elen \
       FROM thoughts ORDER BY created_at ASC LIMIT {} START {};",
      ns, dbname, take, start
    );

    // Parse: locate first block with a result array
    let blocks: serde_json::Value = resp.json().await?;
    let result = blocks
      .as_array()
      .and_then(|arr| arr.iter().find_map(|b| b.get("result").and_then(|r| r.as_array()).cloned()))
      .unwrap_or_default();

    // Defensive fallback if some legacy code path still returns Thing objects
    fn as_id_string(v: &serde_json::Value) -> Option<String> {
      v.as_str()
        .map(|s| s.to_string())
        .or_else(|| v.get("id").and_then(|id| id.as_str()).map(|s| s.to_string()))
    }

5) User‑Agent on HTTP clients (observability)
- Rationale: Aids log correlation without behavior change.
- Files: src/lib.rs (HTTP SQL client), src/embeddings.rs (OpenAI embedder/client)
- Minimal diff:

    // src/lib.rs — HTTP SQL client
    let http = Client::builder()
      .user_agent(format!(
        "surreal-mind/{}/reembed ns={} db={}",
        env!("CARGO_PKG_VERSION"), ns, dbname
      ))
      .timeout(Duration::from_secs(20))
      .build()?;

    // src/embeddings.rs — OpenAI client
    let client = reqwest::Client::builder()
      .user_agent(format!("surreal-mind/{}/embeddings", env!("CARGO_PKG_VERSION")))
      .build()?;

## Validation Plan

Commands (copy-paste):

    # Format and lint
    make fmt && make lint

    # Build
    cargo build --release

    # Run tests (default, no DB required)
    cargo test --all

    # Enable DB-backed tests if desired (requires SurrealDB running)
    # surreal start --user root --pass root --bind 127.0.0.1:8000
    RUN_DB_TESTS=1 cargo test

    # Smoke MCP (requires DB)
    ./test_simple.sh || true

    # Ripgrep sanity
    rg -n "inner_voice.*auto_extract|staged_by_thought"
    rg -n "photography_think|photography_search"
rg -n "legacymind_search"

    # Re-embed parsing guard
    rg -n "meta::id\(id\) AS id, content" src/lib.rs
    rg -n "as_array\(\).*find_map\(\)" src/lib.rs

    # User-Agent presence
    rg -n "user_agent\(" src/lib.rs src/embeddings.rs

Acceptance criteria:
- Build succeeds with no clippy warnings (make lint uses -D warnings).
- All tests pass by default; DB-gated tests are skipped unless RUN_DB_TESTS=1.
- list_tools always shows inner_voice, legacymind_search, photography_search, photography_think, photography_memories.
- think_convo: When framework returns tags outside whitelist, persisted thought.tags only include whitelisted tags.
- inner_voice: fetch_thought_candidates executes without binding errors; tag/date filters work in combination.

## Follow-ups / TODO
- Add unit test for tag whitelist enforcement at the handler level (convo_think) by simulating an analysis envelope with disallowed tags. Owner: core.
- Document sim_thresh default scope (thoughts-only) in unified_search schema docs. Owner: core.
- Consider trimming and deduplication on include/exclude tags in inner_voice retrieve params ingestion. Owner: core.

## Appendix
- Commands actually run (summarized):
  - rg -n "inner_voice.*auto_extract|staged_by_thought" → multiple matches in inner_voice.rs confirming staged_by_thought and auto_extract references.
  - Local edits applied to convo_think.rs to enforce tag whitelist and to inner_voice.rs to finalize SQL before binding.
- Notes: No auth or RBAC introduced; changes are minimal and reversible.
