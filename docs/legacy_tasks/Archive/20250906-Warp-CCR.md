# Critical Code Review — surreal-mind (WARP) — 2025-09-06

Commit: 8b1f3fd

1) Executive Summary
- Overall: The codebase demonstrates strong adherence to the WARP guardrails on embeddings and KG-only injection. Core write paths stamp provider/model/dim for thoughts and re-embed utilities, and dimension hygiene is consistently enforced before cosine.
- Key strengths: Clean server/tool separation; consistent SurrealDB usage with bind parameters; thorough schemas; good logging control via MCP_NO_LOG; deterministic local framework pass for think_convo; unified search with correct dim filtering.
- Primary gaps: (1) KG embedding writes inside inject_memories persist raw vectors without metadata stamps (provider/model/dim/embedded_at); (2) Documentation drift (README vs WARP vs code) around think_search vs legacymind_search and submodes; (3) Missing index on thoughts.embedding_dim despite filtering by that field; (4) inner_voice Grok HTTP client lacks explicit timeout; (5) main.rs tool list is outdated.

Top 5 Risks (severity + rationale)
- High — KG embeddings persisted without metadata stamps: inject_memories updates KG rows with only embedding (no provider/model/dim/embedded_at). This violates guardrails and impairs future re-embed hygiene and auditability. Evidence: src/server/mod.rs 895–901.
- High — Docs-code drift (tools & modes): README still documents think_search/memories_search and submode influence, conflicting with server list_tools and WARP guardrails (KG-only injection, submodes removed). Risk of operator misuse. Evidence: README.md 345–361, 443–463 vs src/server/mod.rs 251, 261, 206–327, and WARP.md 16–18.
- Medium — Missing index for embedding_dim: queries filter thoughts by embedding_dim; schema init defines HNSW and other indexes but not embedding_dim. Potential performance issue at scale. Evidence: src/tools/unified_search.rs 155–165 uses WHERE embedding_dim = $dim; schema init at src/server/mod.rs 576–580 lacks an index on embedding_dim; src/indexes.rs 60–63 lists it as an optional expected index.
- Medium — inner_voice external HTTP calls without explicit timeout: OpenAI embedder sets a timeout; Grok synthesis/planner clients do not, risking hangs. Evidence: src/tools/inner_voice.rs 896–906, 837–847 create Client::new() without builder timeout.
- Medium — Subprocess spawning of reembed_kg via cargo run: gated by SURR_ENABLE_SPAWN, but spawning cargo from within the server is brittle; prefer calling the compiled binary or documenting external invocation only. Evidence: src/tools/maintenance.rs 421–459.

Top 5 Quick Wins
- Add provider/model/dim/embedded_at stamping when inject_memories persists KG embeddings. Evidence: src/server/mod.rs 895–901. Simple UPDATE to include those fields.
- Update main.rs startup tool list to match list_tools (remove think_search/memories_search; add unified/photography tools). Evidence: src/main.rs 47–49, src/server/mod.rs 206–327.
- Add a standard index on thoughts.embedding_dim to match query filter. Evidence: src/server/mod.rs 576–580 (current indexes), src/tools/unified_search.rs 155–165.
- Set explicit reqwest timeouts for inner_voice Grok planner/synthesis calls. Evidence: src/tools/inner_voice.rs 837–847, 896–906.
- Reconcile README with WARP and code: replace think_search with legacymind_search/photography_search; clarify KG-only injection and submodes status; remove/relocate SURR_ENFORCE_TLS until implemented in code.

2) Alignment to WARP Agent Guide (guardrails verification)
- Embeddings
  - Stamping on writes (thoughts): present in think_convo and tech_think inserts (embedding_provider/model/dim/embedded_at). Evidence: src/tools/convo_think.rs 100–115; src/tools/tech_think.rs 125–141. inner_voice thought writes also stamp. Evidence: src/tools/inner_voice.rs 367–370.
  - Re-embed SOPs: reembed and reembed_kg stamp provider/model/dim/embedded_at. Evidence: src/bin/reembed_kg.rs 137–146, 215–224.
  - Single provider per runtime: create_embedder selects OpenAI if key, else Candle (no per-call fallback). Evidence: src/embeddings.rs 182–231.
  - No fake/deterministic embedder: only OpenAI and Candle BGE supported; no Nomic/dummy. Evidence: src/embeddings.rs, src/bge_embedder.rs.
  - Dimensional hygiene: enforced before cosine—filters by embedding_dim or checks vector length equality in local cosine code. Evidence: src/tools/unified_search.rs 155–165; src/tools/search_thoughts.rs 112–121, 170–192.
  - Gap: KG embeddings persisted by inject_memories do not stamp metadata when written ad-hoc. Evidence: src/server/mod.rs 895–901. This violates the “Never write embeddings without stamping” guardrail in WARP.

- Injection (KG-only)
  - KG-only retrieval: inject_memories queries kg_entities and kg_observations only; no thought-to-thought injection. Evidence: src/server/mod.rs 830–846.
  - Scale limits: injection_scale 1→5, 2→10, 3→20 enforced. Evidence: src/server/mod.rs 777–782.
  - Thresholds: T1/T2/T3/FLOOR read from env with config fallback. Evidence: src/server/mod.rs 750–776, 940–949.
  - No UNION: achieved with two SELECTs merged client-side. Evidence: src/server/mod.rs 830–846; also WARP.md 80.
  - Candidate pools by tool: applied per tool_name runtime default (convo=500, plan=800, debug=1000, build=400, stuck=600). Evidence: src/server/mod.rs 819–827.

- Tools surface
  - Server list_tools matches new surface (think_convo/plan/debug/build/stuck, memories_create, memories_moderate, inner_voice, legacymind_search, photography_*, detailed_help). Evidence: src/server/mod.rs 196–334.
  - Legacy tools removed in code comments: “legacy think_search removed” and “legacy memories_search removed.” Evidence: src/server/mod.rs 251, 261.
  - Gap: README still documents think_search and older surfaces. Evidence: README.md 345–361, 443–463. main.rs also logs an outdated list at startup. Evidence: src/main.rs 47–49.

- Configuration
  - Env-first: config.rs loads broad set of envs; defaults documented in .env.example. Evidence: src/config.rs 387–474; .env.example.
  - Gap: README mentions SURR_ENFORCE_TLS (79–81) but no code uses it (no grep hit). SURR_DB_SERIAL discussed in README (139–141), but no implementation in code (no grep hit). Recommend either implementing or removing from docs to avoid confusion.

3) Architecture and API surface
- Server bootstrap: rmcp ServerHandler implemented in src/server/mod.rs; stdio transport in main.rs; MCP_NO_LOG honored to avoid non-protocol output. Evidence: src/main.rs 8–12, 21–34, 36–43.
- SurrealDB connection: WebSocket client; signin & use_ns/use_db; helper normalize_ws_url. Evidence: src/server/mod.rs 414–449.
- Schema initialization: creates thoughts (SCHEMAFULL) with HNSW index on embedding, status, created_at, embedding metadata fields; tables for KG entities, edges, observations; candidate tables and indexes; no embedding_dim index defined for thoughts. Evidence: src/server/mod.rs 543–621 (notably 576–580 for indexes).
- Index expectations: indexes.rs declares optional embedding_dim index for thoughts (60–63). Recommend adding it.
- Unified search: thoughtful split between memories (name-like filters) and thoughts (cosine with embedding_dim gate). Evidence: src/tools/unified_search.rs 80–131 and 155–165.
- Prompt registry: detailed_help supports prompt listing and lookup; constraints include MCP_NO_LOG/no mixed dims/KG-only. Evidence: src/tools/detailed_help.rs 23–43, 64–175.

4) Correctness and Reliability
- Central error type (SurrealMindError) maps to rmcp::ErrorData; consistent error categories and mapping. Evidence: src/error.rs 6–52, 102–174.
- Input parsing: flexible deserializers for injection_scale and significance with helpful error messages (e.g., significance=1 rejected for ambiguity). Evidence: src/deserializers.rs 37–93, 129–216.
- Local cosine implementations guard against dimension mismatches. Evidence: src/tools/search_thoughts.rs 143–160; src/tools/inner_voice.rs 760–778.
- Unwrap/expect hotspots: generally avoided in tool paths; a few unwrap_or_default or unwraps in non-critical debug or tests; largest concern is not panics but metadata stamping gap noted above.

5) Security and Privacy
- Logging controls: MCP_NO_LOG disables tracing init; info-level avoids content; deeper previews behind SURR_THINK_DEEP_LOG=1. Evidence: src/main.rs 8–12, 21–34; src/tools/convo_think.rs 49–53.
- Secrets: OpenAI key consumed via bearer; no printing of key; UA tags include SURR_COMMIT_HASH optionally. Evidence: src/embeddings.rs 41–53, 97–121.
- External calls: OpenAI embeddings use 20s timeout; Grok calls lack explicit timeout (see Performance/Reliability gap). Evidence: src/embeddings.rs 49–53 vs src/tools/inner_voice.rs 837–847, 896–906.
- Subprocess spawn: reembed_kg guarded by SURR_ENABLE_SPAWN; returns advisory when disabled (good). Evidence: src/tools/maintenance.rs 433–444.

6) Performance
- Dimension filtering precedes cosine: present in unified_search and search_thoughts; good hygiene.
- Candidate pools for injection: explicit per-tool default caps; KG-only retrieval prevents O(N) over thoughts. Evidence: src/server/mod.rs 819–827.
- Index coverage: add embedding_dim index for thoughts to match filtering; current HNSW index on embedding exists, plus status/created indexes.
- LRU cache: thoughts cache bounded by SURR_CACHE_MAX, initialized in server::new. Evidence: src/server/mod.rs 459–466.

7) Test and Docs Cohesion
- Tests contain placeholders or references to legacy tools:
  - tests/tool_schemas.rs 19–36 expects think_search/memories_search; server removed these; test should be updated to reflect current surface or to derive expected list from server’s list_tools.
- Docs drift:
  - README vs WARP and code: bidirectional injection and submodes described in README conflict with WARP/CODE (KG-only, submodes removed); tool names out of date; SURR_ENFORCE_TLS and SURR_DB_SERIAL mentioned but not implemented.
  - WARP.md accurately reflects current guardrails and tools; treat it as source of truth.

8) Concrete Suggestions (actionable, prioritized)
- [High] Stamp KG embedding metadata when persisting in inject_memories
  - Evidence: src/server/mod.rs 895–901 updates only embedding; no provider/model/dim/embedded_at.
  - Fix: When persisting KG embeddings (kg_entities/kg_observations), also set embedding_provider, embedding_model, embedding_dim (from self.get_embedding_metadata) and embedded_at = time::now(). Ensure schema tolerates these fields (tables are SCHEMALESS, so it’s fine).
  - Impact: Restores full embedding hygiene for KG rows; enables reliable re-embed checks and avoids mixed-dim confusion.

- [High] Reconcile README and startup logs with actual tools and guardrails
  - Evidence: README.md 345–361, 443–463 reference think_search/memories_search; src/main.rs 47–49 logs outdated list; WARP.md and list_tools show legacymind_search/photography_search and submodes removed.
  - Fix: Update README to:
    - Replace think_search with legacymind_search (and photography_search), noting include_thoughts to include thoughts.
    - Clarify KG-only injection and removal of submodes; remove bidirectional injection claims.
    - Remove or mark as future: SURR_ENFORCE_TLS and SURR_DB_SERIAL unless implemented.
    - Update main.rs startup info string to match list_tools.
  - Impact: Reduces operator confusion and wrong calls; improves onboarding accuracy.

- [Medium] Add thoughts.embedding_dim index to match WHERE filters
  - Evidence: src/tools/unified_search.rs 155–165; schema lacks index on embedding_dim (src/server/mod.rs 576–580). indexes.rs lists it as optional.
  - Fix: In schema init, add DEFINE INDEX idx_thoughts_embedding_dim ON TABLE thoughts FIELDS embedding_dim; consider making it required in indexes.rs.
  - Impact: Improves search performance at scale.

- [Medium] Add explicit HTTP timeouts for Grok planner/synthesis
  - Evidence: src/tools/inner_voice.rs 837–847, 896–906 instantiate Client::new() without timeout; embeddings OpenAI client uses 20s timeout.
  - Fix: Build reqwest::Client with .timeout(Duration::from_secs(20)) for Grok calls; optionally set connect/read timeouts and sensible retries.
  - Impact: Avoids handler hangs and improves reliability.

- [Medium] Avoid spawning cargo in maintenance; prefer compiled binary or advisory-only
  - Evidence: src/tools/maintenance.rs 421–459 uses Command::new("cargo").
  - Fix: Either:
    - Prefer calling the compiled binary (target/release/reembed_kg) with SURR_ENABLE_SPAWN gate; or
    - Convert handler to advisory-only message instructing operators to run the binary manually (consistent with current advisory when spawn disabled).
  - Impact: Improves operational robustness; reduces environment coupling.

- [Medium] Remove vestigial submode logic from injection or document it strictly as legacy
  - Evidence: src/server/mod.rs 789–804 adjusts thresholds if SURR_SUBMODE_RETRIEVAL=true and submode provided; tool paths pass None and submodes are removed per WARP.md.
  - Fix: Either remove the submode branch entirely to reduce surface area, or gate firmly behind SURR_SUBMODE_RETRIEVAL with clear docs that default tools do not set submode.
  - Impact: Smaller attack surface; easier mental model.

- [Low] Update tests to reflect current tool roster & schemas
  - Evidence: tests/tool_schemas.rs 19–36 referring to think_search/memories_search.
  - Fix: Replace with tests that assert properties of schemas via src/schemas.rs or list_tools response in a feature-gated integration test.
  - Impact: Keeps CI faithful to current API.

- [Low] Ensure unified_search names/fields align across README and detailed_help
  - Evidence: src/tools/detailed_help.rs 121–134 describes legacymind_search args; README still uses legacy think_search docs in multiple places.
  - Fix: Consolidate README unified search documentation to match detailed_help and code.
  - Impact: Improved DX.

- [Low] Consider adding an index on kg_entities(entity_type) or confirm existing composites suffice
  - Evidence: indexes.rs 66–73 includes name, name+data.entity_type. Queries often filter name ~ or name + type and should be fine; consider usage patterns before adding more.

9) Validation plan (post-fix)
- Coding hygiene
  - cargo fmt
  - cargo clippy -- -D warnings
  - cargo check
  - cargo test (optionally with RUST_LOG=debug -- --nocapture)

- Embedding hygiene check
  - maintenance_ops { subcommand: "health_check_embeddings" } — confirm mismatched_or_missing=0 across thoughts, kg_entities, kg_observations after stamping changes and any re-embeds.

- Tool surface verification
  - Compare list_tools output with README and main.rs startup logs; verify names and descriptions are consistent.

- Search smoke tests
  - Exercise legacymind_search with include_thoughts=true and verify embedding_dim filters are obeyed and results returned; confirm performance improvements with embedding_dim index.

- inner_voice reliability
  - Exercise inner_voice retrieval in an environment with and without GROK_API_KEY; confirm timeouts prevent hangs and advisory falls back correctly.

- Re-embed process
  - Prefer running compiled reembed_kg binary externally (documented path) or gated spawn; confirm it stamps provider/model/dim/embedded_at and distribution reports align.

Next steps
- Triage suggestions by severity:
  - High: implement KG embedding stamps; reconcile docs and startup tool logs.
  - Medium: add embedding_dim index; add Grok HTTP timeouts; refine reembed_kg invocation; prune submode branch or gate explicitly.
  - Low: update tests/documentation cohesion.
- After fixes, follow the validation plan and record outcomes under a new CCR addendum file.

